"use strict";(()=>{var e={};e.id=411,e.ids=[411],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},32694:e=>{e.exports=require("http2")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},31849:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>h,patchFetch:()=>v,requestAsyncStorage:()=>w,routeModule:()=>p,serverHooks:()=>f,staticGenerationAsyncStorage:()=>m});var r={};a.r(r),a.d(r,{GET:()=>d});var n=a(49303),s=a(88716),i=a(60670),o=a(87070),c=a(26039),l=a(11111),u=a(52013);async function d(e){let t=e.headers.get("authorization"),a=process.env.CRON_SECRET;if(a&&t!==`Bearer ${a}`)return o.NextResponse.json({error:"Unauthorized"},{status:401});console.log("=== Starting watch check ===");try{let e=await (0,c.cQ)();console.log(`Checking ${e.length} active watches`);let t=0,a=0;for(let r of e)try{let e=await (0,l.gR)(r.eventId,r.maxPrice,r.quantity);if(await (0,c.qk)(r._id.toString(),"active"),e.available){if(console.log(`MATCH! ${r.eventName} has tickets available`),!await (0,c.PR)(r.userId)){console.error(`User ${r.userId} not found`);continue}let n=r.maxPrice?`€${e.price} (you wanted under €${r.maxPrice})`:`€${e.price}`,s=`TICKETS AVAILABLE!

*${r.eventName}*
${r.venue}
${r.dateStart}
${n}
${r.quantity}x tickets

Act fast - these won't last!
`+(r.buyUrl?`
Buy now: ${r.buyUrl}`:""),i=await (0,u.Zv)(r.userId,s);i.success?(await (0,c.Iw)(r._id.toString(),r.userId,r.eventName,e.price||0),t++,console.log(`Alert sent for ${r.eventName}`)):(console.error(`Failed to send alert: ${i.error}`),a++)}}catch(e){console.error(`Error checking watch ${r._id}: ${e.message}`),a++}return console.log(`=== Check complete: ${e.length} checked, ${t} alerts, ${a} errors ===`),o.NextResponse.json({status:"ok",checked:e.length,alertsSent:t,errors:a,timestamp:new Date().toISOString()})}catch(e){return console.error("Cron job error:",e),o.NextResponse.json({error:e.message},{status:500})}}let p=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/cron/check-watches/route",pathname:"/api/cron/check-watches",filename:"route",bundlePath:"app/api/cron/check-watches/route"},resolvedPagePath:"C:\\Users\\dylan\\OneDrive\\Desktop\\dylan-portfolio\\ticketwatch\\app\\api\\cron\\check-watches\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:w,staticGenerationAsyncStorage:m,serverHooks:f}=p,h="/api/cron/check-watches/route";function v(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:m})}},26039:(e,t,a)=>{a.d(t,{Sr:()=>y,fd:()=>b,r4:()=>u,bv:()=>f,cQ:()=>v,BZ:()=>m,PR:()=>d,ov:()=>p,W7:()=>h,Iw:()=>x,yL:()=>w,qk:()=>g});let r=require("mongodb"),n=process.env.MONGODB_URI||"";n||console.warn("MONGODB_URI not set - database operations will fail");let s=null;async function i(){if(s)return s.db;let e=new r.MongoClient(n);await e.connect();let t=e.db("ticketwatch");return s={client:e,db:t},t}async function o(){return(await i()).collection("users")}async function c(){return(await i()).collection("watches")}async function l(){return(await i()).collection("alerts")}async function u(e,t){let a=await o();await a.updateOne({_id:e},{$set:{phone:t,lastActivity:new Date},$setOnInsert:{tier:"free",createdAt:new Date,conversationState:null}},{upsert:!0})}async function d(e){return(await o()).findOne({_id:e})}async function p(e){let t=await d(e);return t?.tier||"free"}async function w(e,t){let a=await o();await a.updateOne({_id:e},{$set:{conversationState:t}})}async function m(e){let t=await d(e);return t?.conversationState||null}async function f(e,t,a,r,n,s,i,o){let l=await c();return await l.findOne({userId:e,eventId:t,status:"active"})?null:(await l.insertOne({userId:e,eventId:t,eventName:a,venue:r,dateStart:n,maxPrice:s,quantity:i,status:"active",buyUrl:o,createdAt:new Date,lastChecked:null,alertedAt:null})).insertedId.toString()}async function h(e,t="active"){return(await c()).find({userId:e,status:t}).sort({createdAt:-1}).toArray()}async function v(){return(await c()).find({status:"active"}).sort({lastChecked:1}).toArray()}async function g(e,t){let a=await c();await a.updateOne({_id:new r.ObjectId(e)},{$set:{status:t,lastChecked:new Date}})}async function y(e){let t=await c();await t.updateOne({_id:new r.ObjectId(e)},{$set:{status:"cancelled"}})}async function b(e){return(await c()).countDocuments({userId:e,status:"active"})}async function x(e,t,a,n){let s=await l();await s.insertOne({watchId:new r.ObjectId(e),userId:t,eventName:a,currentPrice:n,sentAt:new Date});let i=await c();await i.updateOne({_id:new r.ObjectId(e)},{$set:{status:"alerted",alertedAt:new Date}})}},11111:(e,t,a)=>{a.d(t,{Dt:()=>l,gR:()=>u,gT:()=>o});let r=process.env.TICKETMASTER_API_KEY||"",n="https://app.ticketmaster.com/discovery/v2",s=!r,i=[{id:"Z698xZaZeEe11",name:"Fred Again",dates:{start:{localDate:"2026-03-15",localTime:"20:00"},status:{code:"onsale"}},_embedded:{venues:[{name:"3Arena Dublin",city:{name:"Dublin"}}]},priceRanges:[{min:65,max:145}],url:"https://www.ticketmaster.ie/fred-again-dublin-03-15-2026/event/12345"},{id:"Z123xZaZeEe22",name:"The 1975",dates:{start:{localDate:"2026-04-20",localTime:"19:30"},status:{code:"offsale"}},_embedded:{venues:[{name:"O2 Dublin",city:{name:"Dublin"}}]},priceRanges:[{min:75,max:125}],url:"https://www.ticketmaster.ie/the-1975-dublin-04-20-2026/event/67890"},{id:"Z456xZaZeEe33",name:"Electric Picnic",dates:{start:{localDate:"2026-09-05",localTime:"11:00"},status:{code:"offsale"}},_embedded:{venues:[{name:"Laois Picnic",city:{name:"Laois"}}]},priceRanges:[{min:125,max:185}],url:"https://www.ticketmaster.ie/electric-picnic-laois-09-05-2026/event/11111"}];async function o(e,t=10){if(s){let t=e.toLowerCase(),a=i.filter(e=>e.name.toLowerCase().includes(t));return a.length>0?a:i.slice(0,3)}let a=new URLSearchParams({apikey:r,keyword:e,countryCode:"IE",size:String(t),sort:"date,asc"});try{let e=await fetch(`${n}/events.json?${a}`,{signal:AbortSignal.timeout(1e4)});if(!e.ok)return[];let t=await e.json();return t?._embedded?.events||[]}catch{return[]}}async function c(e){if(s)return i.find(t=>t.id===e)||null;let t=new URLSearchParams({apikey:r});try{let a=await fetch(`${n}/events/${e}.json?${t}`,{signal:AbortSignal.timeout(1e4)});if(!a.ok)return null;return a.json()}catch{return null}}function l(e){if(!e)return null;let t="TBA",a="";e._embedded?.venues?.[0]&&(t=e._embedded.venues[0].name||"TBA",a=e._embedded.venues[0].city?.name||"");let r=e.dates?.start||{},n=e.priceRanges?.[0]?.min??null,s=e.priceRanges?.[0]?.max??null,i=e.dates?.status?.code||"unknown";return{id:e.id,name:e.name,venue:t,city:a,date:r.localDate||"TBA",time:r.localTime||"",priceMin:n,priceMax:s,status:i,url:e.url||""}}async function u(e,t,a){let r=await c(e);if(!r)return{available:!1,status:"not_found",details:"Event not found"};let n=r.dates?.status?.code||"unknown";if("onsale"!==n)return{available:!1,status:n,details:`Event status: ${n}`};let s=r.priceRanges||[];if(!s.length)return{available:!1,status:"no_pricing",details:"No pricing information available"};let i=s[0].min,o=s[0].max;return t&&i?i<=t?{available:!0,status:"onsale",price:i,priceMax:o,details:`Tickets available from €${i}`}:{available:!1,status:"above_target",price:i,details:`Cheapest ticket €${i} (your target: €${t})`}:{available:!0,status:"onsale",price:i,priceMax:o,details:`Tickets available from €${i}`}}},52013:(e,t,a)=>{a.d(t,{SU:()=>u,Zv:()=>l});var r=a(5558),n=a.n(r);let s=process.env.TWILIO_ACCOUNT_SID||"",i=process.env.TWILIO_AUTH_TOKEN||"",o=process.env.TWILIO_WHATSAPP_NUMBER||"whatsapp:+14155238886",c=null;async function l(e,t){try{let a=function(){if(!c){if(!s||!i)throw Error("TWILIO_ACCOUNT_SID and TWILIO_AUTH_TOKEN must be set");c=n()(s,i)}return c}(),r=await a.messages.create({from:o,to:e.startsWith("whatsapp:")?e:`whatsapp:${e}`,body:t});return{success:!0,sid:r.sid}}catch(e){return console.error("Twilio send error:",e.message),{success:!1,error:e.message}}}function u(e){let t=new(n()).twiml.MessagingResponse;return t.message(e),t.toString()}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[276,242],()=>a(31849));module.exports=r})();